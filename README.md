# A MongoDB-based store for Quartz

## Project Fork Notice

**This project is a fork of [michaelklishin/quartz-mongodb](https://github.com/michaelklishin/quartz-mongodb)**

This project is based on the MongoDB-backed job store originally developed by MuleSoft and later maintained by Michael
S. Klishin. We created this fork to modernize the package structure and build system for better integration with current
development practices.

### What Changed in This Fork:

- **Package Refactoring**: All packages have been renamed from `com.novemberain.quartz.mongodb` to
  `io.fundoc.quartz.mongodb`
- **Build System Migration**: Migrated from Gradle to Maven for better ecosystem compatibility
- **Maven Coordinates**: Updated to `groupId: io.fundoc`, `artifactId: quartz-mongodb`, `version: 1.0.0`
- **Security Updates**: All dependencies upgraded to latest secure versions

### Migration Guide:

If you're migrating from the original `com.novemberain` packages:

1. Update all import statements in your code from `com.novemberain.quartz.mongodb.*` to `io.fundoc.quartz.mongodb.*`
2. Update your Maven/Gradle dependencies to use the new coordinates
3. Update any configuration files that reference the old package names

## What is This?

This is a MongoDB-backed job store for the [Quartz scheduler](http://quartz-scheduler.org/). It supports all Quartz
trigger types and tries to be as feature complete as possible.

## Maven Artifacts

### Current Release (Maven)

Add the following dependency to your `pom.xml`:

``` xml
<dependency>
    <groupId>io.fundoc</groupId>
    <artifactId>quartz-mongodb</artifactId>
    <version>1.0.0</version>
</dependency>
```

### Building from Source

This project now uses Maven for building. To build from source:

```bash
# Compile the project
mvn clean compile

# Run tests (requires MongoDB)
mvn test

# Create JAR
mvn package

# Install to local repository
mvn install
```

### Legacy Information (Original Project)

The original project by michaelklishin used different coordinates and Gradle:

Artifacts were released to [Bintray](https://bintray.com/michaelklishin/maven/).

Original Maven coordinates:

``` xml
<dependency>
    <groupId>com.novemberain</groupId>
    <artifactId>quartz-mongodb</artifactId>
    <version>2.2.0-rc2</version>
</dependency>
```

Original Gradle coordinates:

``` groovy
compile "com.novemberain:quartz-mongodb:2.2.0-rc2"
```

## Usage

Like most things in Quartz, this job store is configured
via a property file, `quartz.properties`:

``` ini
# Use the MongoDB store
org.quartz.jobStore.class=io.fundoc.quartz.mongodb.MongoDBJobStore
# MongoDB URI (optional if 'org.quartz.jobStore.addresses' is set)
org.quartz.jobStore.mongoUri=mongodb://localhost:27020
# comma separated list of mongodb hosts/replica set seeds (optional if 'org.quartz.jobStore.mongoUri' is set)
org.quartz.jobStore.addresses=host1,host2
# database name
org.quartz.jobStore.dbName=quartz
# Will be used to create collections like mycol_jobs, mycol_triggers, mycol_calendars, mycol_locks
org.quartz.jobStore.collectionPrefix=mycol
# thread count setting is ignored by the MongoDB store but Quartz requries it
org.quartz.threadPool.threadCount=1
```

### Error Handling in Clustered Mode

When running in clustered mode, the store will periodically check in
with the cluster. Should that operation fail, the store needs to
decide what to do:

* Shut down
* Do nothing and optimistically proceed

Different strategies make sense in different scenarios. Pausing Quartz would
be optimal but this job store currently doesn't have that option.

The `org.quartz.jobStore.checkInErrorHandler.class` property controls the error handler
implementation.

To shut down the JVM (which is the default), add the following key to `quartz.properties`

    org.quartz.jobStore.checkInErrorHandler.class=io.fundoc.quartz.mongodb.cluster.FailFastErrorHandler

to ignore the failure:

    org.quartz.jobStore.checkInErrorHandler.class=io.fundoc.quartz.mongodb.cluster.NoOpErrorHandler

### Clojure and Quartzite

If you use [Quartzite](http://clojurequartz.info) or want your job classes to be available
to Clojure code, use:

    org.quartz.jobStore.class=io.fundoc.quartz.mongodb.DynamicMongoDBJobStore

(this assumes Clojure jar is on classpath).

### Job Data storage

By default you are allowed to pass any `java.io.Serializable` objects inside `JobDataMap`.
It will be serialized and stored as a `base64` string.

If your `JobDataMap` only contains simple types, it may be stored directly inside MongoDB to save some performance.

``` ini
org.quartz.jobStore.jobDataAsBase64=false
```

## Clustering

To enable clustering set the following property:

``` ini
# turn clustering on:
org.quartz.jobStore.isClustered=true

# Must be unique for each node or AUTO to use autogenerated:
org.quartz.scheduler.instanceId=AUTO
# org.quartz.scheduler.instanceId=node1

# The same cluster name on each node:
org.quartz.scheduler.instanceName=clusterName
```

Each node in a cluster must have the same properties, except *instanceId*.
To setup other clusters use different collection prefix:

``` ini
org.quartz.scheduler.collectionPrefix=yourCluster
```

Different time settings for cluster operations:

``` ini
# Frequency (in milliseconds) at which this instance checks-in to cluster.
# Affects the rate of detecting failed instances.
# Defaults to 7500 ms.
org.quartz.jobStore.clusterCheckinInterval=10000

# Time in millis after which a trigger can be considered as expired.
# Defaults to 10 minutes:
org.quartz.jobStore.triggerTimeoutMillis=1200000

# Time in millis after which a job can be considered as expired.
# Defaults to 10 minutes:
org.quartz.jobStore.jobTimeoutMillis=1200000

# Time limit in millis after which a trigger should be treated as misfired.
# Defaults to 5000 ms.
org.quartz.jobStore.misfireThreshold=10000

# WriteConcern timeout in millis when writing in Replica Set.
# Defaults to 5000 ms.
org.quartz.jobStore.mongoOptionWriteConcernTimeoutMillis=10000
```

## Copyright & License

(c) fundoc-io, 2024. Based on work by Michael S. Klishin, Alex Petrov, 2011-2020.

[Apache Public License 2.0](http://www.apache.org/licenses/LICENSE-2.0.html)
